name: ğŸ§ª Staging Deployment Pipeline

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for staging (optional)'
        required: false
        default: 'develop'
      reset_data:
        description: 'Reset staging database'
        type: boolean
        required: false
        default: false

env:
  REGISTRY: ghcr.io
  REGISTRY_PREFIX: ghcr.io/philksr/planetplant
  NODE_VERSION: '20'
  STAGING_PREFIX: staging

jobs:
  # =============================================================================
  # BUILD STAGING IMAGES
  # =============================================================================
  build-staging:
    name: ğŸ—ï¸ Build Staging Images
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
      
    outputs:
      version: ${{ steps.version.outputs.version }}
      backend-digest: ${{ steps.build-backend.outputs.digest }}
      frontend-digest: ${{ steps.build-frontend.outputs.digest }}
      nginx-digest: ${{ steps.build-nginx.outputs.digest }}
      
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref || 'develop' }}
        
    - name: ğŸ·ï¸ Generate Staging Version
      id: version
      run: |
        if [ "${{ github.event.inputs.version }}" != "" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="develop-$(date +'%Y%m%d')-$(git rev-parse --short HEAD)"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Staging Version: ${VERSION}"
        
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/amd64,linux/arm64
        
    - name: ğŸ” Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ—ï¸ Build & Push Staging Backend
      id: build-backend
      uses: docker/build-push-action@v5
      with:
        context: ./raspberry-pi
        file: ./raspberry-pi/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.REGISTRY_PREFIX }}/backend:develop
          ${{ env.REGISTRY_PREFIX }}/backend:${{ steps.version.outputs.version }}
        labels: |
          org.opencontainers.image.title=PlanetPlant Backend (Staging)
          org.opencontainers.image.description=Smart IoT Plant Watering System - Backend API (Staging)
          org.opencontainers.image.version=${{ steps.version.outputs.version }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha,scope=backend-staging
        cache-to: type=gha,mode=max,scope=backend-staging
        
    - name: ğŸŒ Build & Push Staging Frontend
      id: build-frontend
      uses: docker/build-push-action@v5
      with:
        context: ./webapp
        file: ./webapp/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.REGISTRY_PREFIX }}/frontend:develop
          ${{ env.REGISTRY_PREFIX }}/frontend:${{ steps.version.outputs.version }}
        labels: |
          org.opencontainers.image.title=PlanetPlant Frontend (Staging)
          org.opencontainers.image.description=Smart IoT Plant Watering System - React PWA (Staging)
          org.opencontainers.image.version=${{ steps.version.outputs.version }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha,scope=frontend-staging
        cache-to: type=gha,mode=max,scope=frontend-staging
        
    - name: ğŸ”€ Build & Push Staging Nginx
      id: build-nginx
      uses: docker/build-push-action@v5
      with:
        context: ./nginx
        file: ./nginx/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.REGISTRY_PREFIX }}/nginx-proxy:develop
          ${{ env.REGISTRY_PREFIX }}/nginx-proxy:${{ steps.version.outputs.version }}
        labels: |
          org.opencontainers.image.title=PlanetPlant Nginx (Staging)
          org.opencontainers.image.description=Smart IoT Plant Watering System - Reverse Proxy (Staging)
          org.opencontainers.image.version=${{ steps.version.outputs.version }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha,scope=nginx-staging
        cache-to: type=gha,mode=max,scope=nginx-staging

  # =============================================================================
  # STAGING TESTING
  # =============================================================================
  test-staging:
    name: ğŸ§ª Staging Tests
    runs-on: ubuntu-latest
    needs: [build-staging]
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref || 'develop' }}
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ“‹ Create Staging Test Environment
      run: |
        # Create staging environment file
        cat > .env.staging << EOF
        NODE_ENV=staging
        REGISTRY_PREFIX=${{ env.REGISTRY_PREFIX }}
        IMAGE_TAG=${{ needs.build-staging.outputs.version }}
        INFLUXDB_ORG=planetplant-staging
        INFLUXDB_BUCKET=sensor-data-staging
        INFLUXDB_TOKEN=plantplant-staging-token
        LOG_LEVEL=debug
        EOF
        
    - name: ğŸ” Login to Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“ Setup Staging Directories
      run: |
        mkdir -p {data,config,logs}/staging/{influxdb,mosquitto,redis,grafana,backend,nginx}
        chmod -R 755 data config logs
        
    - name: ğŸš€ Start Staging Environment
      run: |
        # Load staging environment
        set -a && source .env.staging && set +a
        
        # Start staging services
        docker compose -f docker-compose.staging.yml up -d --no-build
        
    - name: â³ Wait for Staging Services
      run: |
        echo "â³ Waiting for staging services to initialize..."
        sleep 45
        
    - name: ğŸ©º Staging Health Checks
      run: |
        echo "ğŸ©º Testing staging health endpoints..."
        
        # InfluxDB staging
        timeout 60 bash -c 'until curl -f http://localhost:8087/ping; do sleep 2; done'
        echo "âœ… InfluxDB Staging is healthy"
        
        # Backend API staging
        timeout 60 bash -c 'until curl -f http://localhost:3002/api/system/status; do sleep 2; done'
        echo "âœ… Backend Staging API is healthy"
        
        # Frontend staging
        timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done'
        echo "âœ… Frontend Staging is healthy"
        
    - name: ğŸ§ª Staging API Tests
      run: |
        echo "ğŸ§ª Running staging API tests..."
        
        # Test system status
        RESPONSE=$(curl -s http://localhost:8080/api/system/status)
        if echo "$RESPONSE" | jq -e '.success == true' > /dev/null; then
          echo "âœ… Staging system status API working"
        else
          echo "âŒ Staging system status API failed"
          echo "Response: $RESPONSE"
          exit 1
        fi
        
        # Test plants API
        PLANTS_RESPONSE=$(curl -s http://localhost:8080/api/plants)
        if echo "$PLANTS_RESPONSE" | jq -e '.success == true' > /dev/null; then
          echo "âœ… Staging plants API working"
        else
          echo "âŒ Staging plants API failed"
          echo "Response: $PLANTS_RESPONSE"
          exit 1
        fi
        
    - name: ğŸ§ª Staging Integration Tests
      run: |
        echo "ğŸ§ª Running staging integration tests..."
        
        # Test MQTT connectivity (if available)
        if command -v mosquitto_pub &> /dev/null; then
          echo "ğŸ“¡ Testing MQTT staging..."
          mosquitto_pub -h localhost -p 1884 -t "test/staging" -m "integration test" || true
          echo "âœ… MQTT staging accessible"
        fi
        
        # Test database connectivity
        echo "ğŸ—„ï¸ Testing database staging..."
        INFLUX_RESPONSE=$(curl -s "http://localhost:8087/api/v2/ready")
        if echo "$INFLUX_RESPONSE" | jq -e '.status == "ready"' > /dev/null; then
          echo "âœ… InfluxDB staging ready"
        else
          echo "âš ï¸ InfluxDB staging not ready (may be normal during startup)"
        fi
        
    - name: ğŸ“Š Staging Performance Tests
      run: |
        echo "ğŸ“Š Running staging performance tests..."
        
        # API response time tests
        for endpoint in "system/status" "plants"; do
          echo "Testing /api/$endpoint..."
          for i in {1..3}; do
            START=$(date +%s%N)
            curl -s "http://localhost:8080/api/$endpoint" > /dev/null
            END=$(date +%s%N)
            DURATION=$(( (END - START) / 1000000 ))
            echo "  Response $i: ${DURATION}ms"
            
            if [ $DURATION -gt 3000 ]; then
              echo "âŒ Staging API too slow: ${DURATION}ms"
              exit 1
            fi
          done
        done
        echo "âœ… Staging performance acceptable"
        
    - name: ğŸ›‘ Cleanup Staging Test
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up staging test environment..."
        docker compose -f docker-compose.staging.yml logs --tail=50 || true
        docker compose -f docker-compose.staging.yml down -v || true

  # =============================================================================
  # DEPLOY TO STAGING
  # =============================================================================
  deploy-staging:
    name: ğŸ­ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-staging, test-staging]
    if: ${{ always() && needs.build-staging.result == 'success' && needs.test-staging.result == 'success' }}
    environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref || 'develop' }}
      
    - name: ğŸ” Setup SSH for Staging
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H "${{ secrets.PI_HOST }}" >> ~/.ssh/known_hosts
        
    - name: ğŸ“¦ Prepare Staging Deployment
      run: |
        # Create staging environment file
        cat > deploy.staging.env << EOF
        REGISTRY_PREFIX=${{ env.REGISTRY_PREFIX }}
        IMAGE_TAG=${{ needs.build-staging.outputs.version }}
        NODE_ENV=staging
        INFLUXDB_ORG=planetplant-staging
        INFLUXDB_BUCKET=sensor-data-staging
        INFLUXDB_TOKEN=plantplant-staging-token
        LOG_LEVEL=debug
        EOF
        
    - name: ğŸ“¤ Upload Staging Files
      run: |
        # Create staging directory on Pi
        ssh pi@${{ secrets.PI_HOST }} "mkdir -p /opt/planetplant/staging"
        
        # Upload staging compose and config
        scp docker-compose.staging.yml pi@${{ secrets.PI_HOST }}:/opt/planetplant/staging/
        scp deploy.staging.env pi@${{ secrets.PI_HOST }}:/opt/planetplant/staging/.env
        
        # Create staging directories
        ssh pi@${{ secrets.PI_HOST }} "
          cd /opt/planetplant/staging &&
          mkdir -p {data,config,logs}/staging/{influxdb,mosquitto,redis,grafana,backend,nginx} &&
          chmod -R 755 data config logs
        "
        
    - name: ğŸ” Registry Login on Staging
      run: |
        ssh pi@${{ secrets.PI_HOST }} "echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin"
        
    - name: ğŸ—„ï¸ Reset Staging Data (if requested)
      if: ${{ inputs.reset_data }}
      run: |
        ssh pi@${{ secrets.PI_HOST }} "
          cd /opt/planetplant/staging &&
          echo 'ğŸ—‘ï¸ Resetting staging data...' &&
          docker compose -f docker-compose.staging.yml down -v &&
          rm -rf data/staging/* logs/staging/* &&
          echo 'âœ… Staging data reset completed'
        "
        
    - name: ğŸš€ Deploy to Staging
      run: |
        ssh pi@${{ secrets.PI_HOST }} "
          cd /opt/planetplant/staging &&
          echo 'ğŸ­ Starting staging deployment...' &&
          
          # Pull new staging images
          docker compose -f docker-compose.staging.yml pull &&
          
          # Start staging environment
          docker compose -f docker-compose.staging.yml up -d &&
          
          echo 'âœ… Staging deployment completed'
        "
        
    - name: â³ Staging Warmup
      run: |
        echo "â³ Waiting for staging services to warm up..."
        sleep 30
        
    - name: ğŸ©º Post-Deploy Staging Health Check
      run: |
        ssh pi@${{ secrets.PI_HOST }} "
          echo 'ğŸ©º Running staging health checks...' &&
          
          # Check container status
          docker compose -f docker-compose.staging.yml -C /opt/planetplant/staging ps &&
          
          # Health endpoint tests
          timeout 60 bash -c 'until curl -f http://localhost:8087/ping; do sleep 2; done' &&
          echo 'âœ… InfluxDB Staging healthy' &&
          
          timeout 60 bash -c 'until curl -f http://localhost:3002/api/system/status; do sleep 2; done' &&
          echo 'âœ… Backend Staging healthy' &&
          
          timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done' &&
          echo 'âœ… Frontend Staging healthy' &&
          
          echo 'ğŸ‰ All staging health checks passed!'
        "

  # =============================================================================
  # STAGING VALIDATION TESTS
  # =============================================================================
  validate-staging:
    name: âœ… Staging Validation
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    
    steps:
    - name: ğŸ” Setup SSH for Validation
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H "${{ secrets.PI_HOST }}" >> ~/.ssh/known_hosts
        
    - name: ğŸ§ª Comprehensive Staging Tests
      run: |
        ssh pi@${{ secrets.PI_HOST }} "
          echo 'ğŸ§ª Running comprehensive staging validation...' &&
          
          # Test all API endpoints
          echo 'Testing system status...' &&
          RESPONSE=\$(curl -s http://localhost:8080/api/system/status) &&
          echo \"\$RESPONSE\" | jq -e '.success == true' > /dev/null &&
          echo 'âœ… System status OK' &&
          
          echo 'Testing plants API...' &&
          PLANTS=\$(curl -s http://localhost:8080/api/plants) &&
          echo \"\$PLANTS\" | jq -e '.success == true' > /dev/null &&
          echo 'âœ… Plants API OK' &&
          
          # Test frontend
          echo 'Testing frontend...' &&
          curl -f http://localhost:8080/ > /dev/null &&
          echo 'âœ… Frontend accessible' &&
          
          # Performance validation
          echo 'Testing performance...' &&
          for i in {1..5}; do
            START=\$(date +%s%N) &&
            curl -s http://localhost:8080/api/system/status > /dev/null &&
            END=\$(date +%s%N) &&
            DURATION=\$(( (END - START) / 1000000 )) &&
            echo \"Performance test \$i: \${DURATION}ms\" &&
            if [ \$DURATION -gt 2000 ]; then
              echo 'âŒ Staging performance issue: '\${DURATION}'ms' &&
              exit 1
            fi
          done &&
          
          echo 'ğŸ‰ All staging validation tests passed!'
        "
        
    - name: ğŸ“Š Staging Environment Summary
      run: |
        ssh pi@${{ secrets.PI_HOST }} "
          cd /opt/planetplant/staging &&
          echo 'ğŸ“Š Staging Environment Summary' &&
          echo '=============================' &&
          echo 'ğŸ³ Container Status:' &&
          docker compose -f docker-compose.staging.yml ps &&
          echo '' &&
          echo 'ğŸ’¾ Resource Usage:' &&
          docker stats --no-stream --format 'table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}' \$(docker compose -f docker-compose.staging.yml ps -q) &&
          echo '' &&
          echo 'ğŸŒ Access URLs:' &&
          echo '  Frontend: http://${{ secrets.PI_HOST }}:8080' &&
          echo '  Backend API: http://${{ secrets.PI_HOST }}:3002/api' &&
          echo '  InfluxDB: http://${{ secrets.PI_HOST }}:8087' &&
          echo '  Grafana: http://${{ secrets.PI_HOST }}:3003' &&
          echo '' &&
          echo 'âœ… Staging deployment ready for testing!'
        "

  # =============================================================================
  # STAGING NOTIFICATIONS
  # =============================================================================
  notify-staging:
    name: ğŸ“¢ Staging Notifications
    runs-on: ubuntu-latest
    needs: [build-staging, test-staging, deploy-staging, validate-staging]
    if: always()
    
    steps:
    - name: ğŸ“Š Determine Staging Status
      id: status
      run: |
        BUILD_STATUS="${{ needs.build-staging.result }}"
        TEST_STATUS="${{ needs.test-staging.result }}"
        DEPLOY_STATUS="${{ needs.deploy-staging.result }}"
        VALIDATE_STATUS="${{ needs.validate-staging.result }}"
        
        if [[ "$BUILD_STATUS" == "success" && "$TEST_STATUS" == "success" && "$DEPLOY_STATUS" == "success" && "$VALIDATE_STATUS" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=ğŸ­ Staging deployment successful" >> $GITHUB_OUTPUT
          echo "color=3447003" >> $GITHUB_OUTPUT  # Blue for staging
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=âŒ Staging deployment failed" >> $GITHUB_OUTPUT  
          echo "color=15105570" >> $GITHUB_OUTPUT  # Orange for staging failure
        fi
        
    - name: ğŸ“± Discord Staging Notification
      if: ${{ env.DISCORD_WEBHOOK != '' }}
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        curl -H "Content-Type: application/json" -X POST \
          -d "{
            \"embeds\": [{
              \"title\": \"${{ steps.status.outputs.message }}\",
              \"description\": \"PlanetPlant Staging Deployment\",
              \"color\": ${{ steps.status.outputs.color }},
              \"fields\": [
                {\"name\": \"Version\", \"value\": \"${{ needs.build-staging.outputs.version }}\", \"inline\": true},
                {\"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                {\"name\": \"Build\", \"value\": \"${{ needs.build-staging.result }}\", \"inline\": true},
                {\"name\": \"Tests\", \"value\": \"${{ needs.test-staging.result }}\", \"inline\": true},
                {\"name\": \"Deploy\", \"value\": \"${{ needs.deploy-staging.result }}\", \"inline\": true},
                {\"name\": \"Validation\", \"value\": \"${{ needs.validate-staging.result }}\", \"inline\": true},
                {\"name\": \"Access\", \"value\": \"http://${{ secrets.PI_HOST }}:8080\", \"inline\": false}
              ],
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
            }]
          }" \
          "$DISCORD_WEBHOOK" || echo "Discord notification failed"
          
    - name: ğŸ“ Staging Summary
      run: |
        echo "ğŸ“‹ Staging Deployment Summary"
        echo "============================="
        echo "ğŸ·ï¸  Version: ${{ needs.build-staging.outputs.version }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ“¦ Build: ${{ needs.build-staging.result }}"
        echo "ğŸ§ª Tests: ${{ needs.test-staging.result }}"
        echo "ğŸ­ Deploy: ${{ needs.deploy-staging.result }}"
        echo "âœ… Validation: ${{ needs.validate-staging.result }}"
        echo "ğŸ“± Status: ${{ steps.status.outputs.status }}"
        echo ""
        if [[ "${{ steps.status.outputs.status }}" == "success" ]]; then
          echo "ğŸ‰ Staging environment ready for testing!"
          echo "ğŸŒ Access: http://${{ secrets.PI_HOST }}:8080"
          echo "ğŸ“Š API: http://${{ secrets.PI_HOST }}:3002/api"
        else
          echo "âŒ Staging deployment failed. Check logs for details."
        fi